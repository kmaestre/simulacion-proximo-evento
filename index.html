<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Proyecto #2 | Simulación y Modelos</title>
  <link rel="stylesheet" href="vendor/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="vendor/alertify.min.css">
  <link rel="stylesheet" type="text/css" href="vendor/alertify.bootstrap.min.css">
  <style>
    * {
      font-family: 'Fira Code'
    }


    #conditionWrapper {
      display: none
    }
  </style>

</head>

<body class="container-fluid">
  <div id="tabla" class="row" style="display: none">
    <table class="table table-striped table-sm">
      <thead>
        <th>TR</th>
        <th>EQO</th>
        <th>NE</th>
        <th>RI</th>
        <th>EG</th>
        <th>LE</th>
      </thead>
      <tbody id="tbody">

      </tbody>
    </table>
  </div>

  <div id="entradadatos" class="full row d-none justify-content-center align-items-center">
    <div id="form">
      <h4 class="text-center">Parametros Iniciales:</h4>
      <br>
      <div class="form-group">
        <label for="">Nº de entidades en el sistema:</label>
        <input type="text" class="form-control" id="entities" oninput="soloNumeros()" onkeydown="removeBorders()">
      </div>
      <div class="form-group">
        <label for="">Condicion de Parada</label>
        <select class="form-control" id="stop" onchange="setInput()">
          <option value="">Seleccionar</option>
          <option value="1">Nº de Solicitudes</option>
          <option value="2">Nº de Finalizados</option>
          <option value="3">Tiempo de simulacion</option>
        </select>
      </div>
      <div id="conditionWrapper">
        <div class="form-group">
          <label for="" id="stopLabel"></label>
          <input class="form-control" id="stopValue1" name="input" onkeydown="removeBorders()" oninput="soloNumeros()">
          <input class="form-control" id="stopValue2" name="input" onkeydown="removeBorders()">
        </div>
      </div>

      <div class="form-group">
        <button id="runBtn" class="btn btn-dark btn-block btn-sm" disabled onclick="runSimulation()">Iniciar</button>
      </div>
    </div>
  </div>

  <script src="vendor/jquery-slim.min.js"></script>
  <script src="vendor/popper.min.js"></script>
  <script src="vendor/bootstrap.min.js"></script>
  <script src="vendor/alertify.js"></script>


  <script>
    //parametros inciales
    var fArrival;
    var fDeparture;

    //variables globales
    var arrivals = [];
    var departures = [];
    var clock = 0;
    var entities = 0;
    var eventList = [];
    var rgNumber = [];
    var stopCondition = '3'
    var stopConditionValue = 12000
    var arrivalCount = 0
    var departureCount = 0
    var generatedEvent

    $('#dataInput').modal()

    $(function () {
      $('#content-tab').on('click', function (e) {
        e.preventDefault()
        $(this).tab('show')
      })
    })

    const soloNumeros = () => {
      event.target.value = event.target.value.replace(/\D/gi, '')
    }
    const soloNumeros2 = () => {
      event.target.value = event.target.value.replace(/(\D)/gi, '')
    }

    const removeBorders = () => {
      event.target.style = ''
      $('errorLabel').css('display', 'none')
    }

    const setInput = () => {
      let val = event.target.value
      if (val == '') {
        $('#conditionWrapper').css('display', 'none')
        $('#runBtn').attr('disabled', true)
        return
      }
      if ('1' === val || '2' === val) {
        $('#stopLabel').text('Cantidad');
        $('#stopValue2').css('display', 'none')
        $('#stopValue1').css('display', 'block')
      }
      if ('3' === val) {
        $('#stopLabel').text('Tiempo(seg)')
        $('#stopValue1').css('display', 'none')
        $('#stopValue2').css('display', 'block')

      }

      $('#conditionWrapper').css('display', 'block')
      $('#runBtn').attr('disabled', false)
    }

    const runSimulation = () => {
      let stopOption = document.getElementById('stop').value
      let stopValue = ''
      let initEntities = document.getElementById('entities').value

      if (!initEntities) {
        document.getElementById('entities').style = 'border: 1px solid red; color: red;'
        return
      } else {
        entities = initEntities
      }
      if (stopOption == '1' && document.getElementById('stopValue1').value != '') {
        // preparar condicion de parada para este caso 
        stopValue = document.getElementById('stopValue1').value
      } else if (stopOption == '2' && document.getElementById('stopValue1').value != '') {
        // preparar condicion de parada para este caso
        stopValue = document.getElementById('stopValue1').value
      } else if (stopOption == '3' && document.getElementById('stopValue2').value != '') {
        // preparar condicion de parada para este caso
        stopValue = document.getElementById('stopValue2').value
      } else {
        if (!stopValue) {
          if (stopOption == '1' || stopOption == '2') {
            document.getElementById('stopValue1').style = 'border: 1px solid red; color: red;'
          }
          if (stopOption == '3') {
            document.getElementById('stopValue2').style = 'border: 1px solid red; color: red;'
          }
          return
        }
        alertify.alert('Info', 'La simulacion se detendra al llegar a los ' + parseInt(stopValue) + ' segundos')
      }

      stopCondition = stopOption
      stopConditionValue = stopValue

      setFirstArrivalQuestion()
    }
    const setFirstDepartureQuestion = () => {
      let html = `
        <div class="modal-body text-center">
          <p>¿Desea indicar el tiempo de la primera <strong>finalizacion de servicio?</strong></p>
          <div class="row">
            <div class="form-group col-5 mx-auto">
              <button class="btn btn-danger btn-block" onclick="fDeparture = null; main()">No</button>
            </div>
            <div class="form-group col-5 mx-auto">
              <button class="btn btn-dark btn-block" onclick="setFirstDeparture()">Si</button>
            </div>
          </div>
        </div>
      `

      $('#form').html(html)
    }
    const setFirstArrivalQuestion = () => {
      let html = `
        <div class="modal-body text-center">
          <p>¿Desea indicar el tiempo de la primera <strong>solicitud de servicio?</strong></p>
          <div class="row">
            <div class="form-group col-5 mx-auto">
              <button class="btn btn-danger btn-block" onclick="fArrival = null;setFirstDepartureQuestion()">No</button>
            </div>
            <div class="form-group col-5 mx-auto">
              <button class="btn btn-dark btn-block" onclick="setFirstArrival()">Si</button>
            </div>
          </div>
        </div>
      `

      $('#form').html(html)
    }
    const setFirstArrival = () => {
      let html = `
        <div class="modal-body text-center">
          <div class="form-group col-12 mx-auto">
            <label>Tiempo (seg)</label>
            <input type="text" class="form-control input-sm" id="firstReq" oninput="soloNumeros()" onfocus="removeBorders()">
          </div>
          <div class="form-group col-5 mx-auto">
            <button class="btn btn-dark btn-block" onclick="
              let val = $('#firstReq').val()
              if (val == '') {
                document.getElementById('firstReq').style = 'border: 1px solid red; color: red;'
                return
              }

              fArrival = val
              setFirstDepartureQuestion()
            ">Aceptar</button>
          </div>
        </div>
      `

      $('#form').html(html)
    }
    const setFirstDeparture = () => {
      let html = `
        <div class="modal-body text-center">
          <div class="form-group col-12 mx-auto">
            <label>Tiempo de Finalizacion <small>(seg)</small>:</label>
            <input type="text" class="form-control input-sm" id="firstDep" onfocus="removeBorders()" oninput="soloNumeros()">
          </div>
          <div class="form-group col-5 mx-auto">
            <button class="btn btn-dark btn-block"  onclick="
              let val = $('#firstDep').val()
              if (val == '') {
                document.getElementById('firstDep').style = 'border: 1px solid red; color: red;'
                return
              }
              fDeparture = val
              main()
            ">Aceptar</button>
          </div>
        </div>
      `

      $('#form').html(html)
    }

    const weibull = (g, a, b, u) => {
      return (g + b * (-Math.log(u)) ** (1 / a))
    }

    const sortEventList = () => {
      eventList.sort((a, b) => (a.time - b.time))
    }

    //si ocurre E2, generar proximo E2 si NE != 0 y E1 si no existe en lista
    const execE2 = () => {
      departureCount += 1
      entities -= 1
      let res = { activeEvent: null, generated: '', ris: [] }
      res.activeEvent = eventList.splice(0, 1)[0]
      clock = res.activeEvent.time
      let newE2 = null
      let newE1 = null
      if (entities > 0) {
        res.ris.push(Math.random())
        newE2 = generateEvent(2, res.ris[res.ris.length - 1])
        eventList.push(newE2)
      }
      if (!arrivalExists()) {
        res.ris.push(Math.random())
        newE1 = generateEvent(1, res.ris[res.ris.length - 1])
        eventList.push(newE1)
      }

      if (newE2 && newE1) {
        res.generated += `E2<sub>(${newE2.time.toFixed(2)})</sub>/E1<sub>(${newE1.time.toFixed(2)})</sub>`
      } else if (newE1 && !newE2) {
        res.generated += `E1<sub>(${newE1.time.toFixed(2)})</sub>`
      } else if (!newE1 && newE2) {
        res.generated += `E2<sub>(${newE2.time.toFixed(2)})</sub>`
      } else if (!newE2 && !newE1) {
        res.generated = '-'
      }

      if (res.ris.length == 0) res.ris = '-'

      sortEventList()
      return res
    }

    //si ocurre E1, generar nuevo E1 y E2 si no existe en lista
    const execE1 = () => {
      entities += 1
      arrivalCount += 1
      let res = { activeEvent: null, generated: null, ris: [] }
      res.activeEvent = eventList.splice(0, 1)[0]
      clock = res.activeEvent.time
      res.ris.push(Math.random())
      let newE1 = generateEvent(1, res.ris[0])
      let newE2 = null
      eventList.push(newE1)
      if (!departureExists()) {
        res.ris.push(Math.random())
        newE2 = generateEvent(2, res.ris[1])
        eventList.push(newE2)
      }

      res.generated = `E1<sub>(${newE1.time.toFixed(2)})</sub>${newE2 ? '/E2<sub>(' + newE2.time.toFixed(2) + ')</sub>' : ''}`

      sortEventList()
      return res
    }

    const getNextEvent = () => {
      let event;
      let pos = 0;
      for (let i = 0; i < eventList.length; i++) {
        if (i == 0) event = eventList[0]
        else if (event.time > eventList[i].time) {
          event = eventList[i]
          pos = i
        }
      }

      return pos
    }
    const printEventList = () => {
      let arr = '';
      eventList.forEach(e => {
        arr = arr + '' + (e.type + '<sub>(') + (e.time.toFixed(2)) + ')</sub> '
      })

      return arr
    }

    const arrivalExists = () => {
      let res = false
      for (let i = 0; i < eventList.length; i++) {
        if (eventList[i].type == 'E1') {
          res = true
          break
        }
      }

      return res
    }
    const departureExists = () => {
      let res = false
      for (let i = 0; i < eventList.length; i++) {
        if (eventList[i].type == 'E2') {
          res = true
          break
        }
      }

      return res
    }

    const generateEvent = (t, u) => {
      if (t == 1) {
        return { type: 'E1', time: clock + weibull(0, 1.06793, 112.482, u), ri: u }
      } else {
        return { type: 'E2', time: clock + weibull(26.954, 1.10966, 34.2411, u), ri: u }
      }
    }

    const printEventRow = (a, b, c, d, e, f) => {
      $('tbody').append(`<tr>
          <td>${(a).toFixed(2)}</td>
          <td>${b}</td>
          <td>${c}</td>
          <td>${d}</td>
          <td>${e}</td>
          <td>${f}
        </tr>`)
    }

    const main = () => {
      $('#tabla').css('display', 'block')
      let stop = false
      stopCondition = '1'
      stopConditionValue = 10

      //variables de linea a imprimir
      let EQO = '-'
      let EG = '-'
      let Ri = '-'
      let ES = (stopCondition == '3') ? ` E3<sub>(${stopConditionValue.toFixed(2)})</sub>` : ''

      printEventRow(clock, EQO, entities, EG, Ri, ES)
      while (!stop && entities < 50) {
        sortEventList()
        Ri = Math.random()
        if (stopCondition == '1' && stopConditionValue <= arrivalCount) stop = true
        else if (stopCondition == '2' && stopConditionValue <= departureCount) stop = true
        else if (stopCondition == '3' && stopConditionValue <= clock) stop = true
        if (!entities) {
          if (arrivalExists()) {
            let { activeEvent, generated, ris } = execE1()
            sortEventList()
            printEventRow(clock, 'E1', entities, `${ris == '-' ? ris : ris.length == 1 ? ris[0].toFixed(3) : ris[0].toFixed(3) + '/' + ris[1].toFixed(3)}`, generated, printEventList() + ES)
          } else {
            let newEvent = generateEvent(1, Ri)
            eventList.push(newEvent)
            sortEventList()
            EG = 'E1<sub>(' + newEvent.time.toFixed(2) + ')</sub>'
            printEventRow(clock, '-', entities, Ri.toFixed(3), EG, printEventList() + ES)
          }
        } else {
          if (eventList.length && eventList[0].type == 'E1') {
            let { activeEvent, ris, generated } = execE1()
            sortEventList()
            printEventList()
            printEventRow(clock, 'E1', entities, `${ris.length == 1 ? ris[0].toFixed(3) : ris[0].toFixed(3) + '/' + ris[1].toFixed(3)}`, generated, printEventList() + ES)
          } else if (eventList.length && eventList[0].type == 'E2') {
            let { activeEvent, ris, generated } = execE2()
            sortEventList()
            printEventList()
            printEventRow(clock, 'E2', entities, `${ris == '-' ? ris : (ris.length == 1) ? ris[0].toFixed(3) : ris[0].toFixed(3) + '/' + ris[1].toFixed(3)}`, generated, printEventList() + ES)
          }
        }
      }

      $('body').append('Solicitudes de Servicio:' + arrivalCount)
      $('body').append('<br>')
      $('body').append('Entidades Atendidas:' + departureCount)
      $('body').append('<br>')
      $('body').append('Entidades en Cola:' + entities)
    }

    /*fin*/
  </script>
</body>

</html>